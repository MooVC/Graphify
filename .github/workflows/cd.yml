name: .NET Build, Test & Publish

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      run_pack_and_publish:
        description: 'Execute Pack and Publish?'
        required: false
        type: boolean

env:
  configuration: 'Release'
  NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages
  PACKAGE_ID: 'Monify'
  solution: 'Monify.sln'

permissions:
  packages: write

jobs:
  build:
    name: Build, Test & Publish
    runs-on: windows-latest

    outputs:
      semantic: ${{ steps.extract-version.outputs.semantic }}

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Use .NET SDKs
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            10.0.x

      - name: Cache NuGet Packages
        uses: actions/cache@v5
        with:
          path: ${{ github.workspace }}/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore NuGet Packages
        run: dotnet restore ${{ env.solution }}

      - name: Extract and Format Version from Tag
        id: extract-version
        shell: bash
        run: |
          # If push event with refs/tags, parse that. Otherwise, fallback to describing the last tag found.
          if [[ "$GITHUB_REF" =~ ^refs/tags/ ]]; then
            rawTag="${GITHUB_REF#refs/tags/}"
          else
            rawTag="$(git describe --tags $(git rev-list --tags --max-count=1) 2>/dev/null || echo "")"
          fi

          # If there's no real tag, rawTag might be empty on a manual run
          if [ -z "$rawTag" ]; then
            echo "No tag found - setting semantic=0.0.0"
            semantic="0.0.0"
          else
            # Remove a leading 'v' if present
            semantic="${rawTag#v}"
          fi

          numeric="${semantic%%-*}.0"

          echo "version=$numeric"       >> $GITHUB_ENV
          echo "semantic=$semantic"     >> $GITHUB_ENV
          echo "informational=$rawTag"  >> $GITHUB_ENV
          echo "semantic=$semantic"     >> $GITHUB_OUTPUT

      - name: Build Solution
        run: dotnet build ${{ env.solution }} --configuration ${{ env.configuration }} --no-restore -p:AssemblyVersion=${{ env.version }} -p:FileVersion=${{ env.version }}   -p:InformationalVersion=${{ env.informational }} -p:PackageVersion=${{ env.semantic }} -p:Version=${{ env.version }}

      - name: Test Solution
        run: dotnet test ${{ env.solution }} --configuration ${{ env.configuration }} --no-build

      - name: Upload Code Coverage
        if: ${{ github.event_name == 'push' }}
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Pack Solution
        if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_pack_and_publish  == 'true') }}
        run: dotnet pack ${{ env.solution }} --configuration ${{ env.configuration }} --no-build --output ./artifacts -p:Version=${{ env.semantic }}

      - name: Publish Packages to GitHub
        if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_pack_and_publish  == 'true') }}
        run: dotnet nuget push **/${{ env.PACKAGE_ID }}*.nupkg --source "https://nuget.pkg.github.com/MooVC/index.json" --api-key ${{ secrets.GITHUB_TOKEN }} --skip-duplicate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
 
      - name: Publish Packages to NuGet
        if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.run_pack_and_publish  == 'true') }}
        run: dotnet nuget push **/${{ env.PACKAGE_ID }}*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate